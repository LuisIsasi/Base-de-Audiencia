#!/bin/bash

function run {
    sudo nginx-configtest &> /dev/null;

    if [ "$?" -eq "1" ]; then
        echo "Error in nginx config; reload aborted"
        exit 1
    fi

    local conf_root="/data/shared/conf/nginx";
    local upstreams="$conf_root/upstreams.conf";
    local temp="$conf_root/temp.conf";
    if [ "$1" = "a" ]; then
        local new_conf="$conf_root/upstreams_a.conf";
    elif [ "$1" = "b" ]; then
        local new_conf="$conf_root/upstreams_b.conf";
    else
        echo "Choose 'a' or 'b' for the audb project.";
        return 1;
    fi
    ln -s "$new_conf" "$temp";
    mv "$temp" "$upstreams";  # Supposedly, do a mv operation will be atomic. Not that it is truly necessary.

    sudo nginx-reload &> /dev/null;
}

run "$@";
